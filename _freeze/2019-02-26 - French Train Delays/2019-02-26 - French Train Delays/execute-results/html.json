{
  "hash": "42a45111964a45d4ed37ece6d6aa3b2a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"French Train Delays\"\nauthor: \"Hippolyte Menou\"\nformat: html\neditor: visual\n---\n\n\n\n\nThis data story explores delays in French train services, with a particular focus on international connections. The dataset comes from the TidyTuesday project and contains information about train delays, journey times across all French stations.\n\n<https://twitter.com/noccaea/status/1095735292206739456>\n\n# Data Preparation\n\nFirst, we load the necessary packages and set up our visualization theme:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse, quietly = T)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_minimal())\n```\n:::\n\n\n\n\n## Data Import and Processing\n\nWe import two datasets: `full_trains` and `small_trains`, with the latter being a subset of the former. To properly categorize international services, we create a list of international stations and a helper function to identify international routes. This allows us to fill in missing service types based on whether either the departure or arrival station is international.\n\nLet's examine the structure of our processed dataset:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfull_trains <- readr::read_csv(\"https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2019/2019-02-26/full_trains.csv\")\nsmall_trains <- readr::read_csv(\"https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2019/2019-02-26/small_trains.csv\") \n\ninternational_stations <- c(\"ZURICH\", \"LAUSANNE\", \"GENEVE\", \"ITALIE\", \"STUTTGART\", \"FRANCFORT\", \"MADRID\", \"BARCELONA\")\n\nis_international <- function(x){x %in% international_stations}\n\nsmall_trains <- small_trains %>% \n  mutate(service = if_else(is.na(service), \n                           if_else(is_international(departure_station) | is_international(arrival_station), \"International\", \"National\"), \n                           service))\n\nsmall_trains %>% \n  glimpse\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 32,772\nColumns: 13\n$ year                    <dbl> 2017, 2017, 2017, 2017, 2017, 2017, 2017, 2017…\n$ month                   <dbl> 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9…\n$ service                 <chr> \"National\", \"National\", \"National\", \"National\"…\n$ departure_station       <chr> \"PARIS EST\", \"REIMS\", \"PARIS EST\", \"PARIS LYON…\n$ arrival_station         <chr> \"METZ\", \"PARIS EST\", \"STRASBOURG\", \"AVIGNON TG…\n$ journey_time_avg        <dbl> 85.13378, 47.06452, 116.23494, 161.08958, 164.…\n$ total_num_trips         <dbl> 299, 218, 333, 481, 190, 191, 208, 216, 661, 2…\n$ avg_delay_all_departing <dbl> 0.7520067, 1.2635177, 1.1392570, 1.4062153, 1.…\n$ avg_delay_all_arriving  <dbl> 0.4198439, 1.1375576, 1.5863956, 4.7885417, 6.…\n$ num_late_at_departure   <dbl> 15, 10, 20, 36, 16, 18, 49, 24, 141, 23, 33, 5…\n$ num_arriving_late       <dbl> 17, 23, 19, 61, 38, 18, 38, 37, 122, 26, 64, 6…\n$ delay_cause             <chr> \"delay_cause_external_cause\", \"delay_cause_ext…\n$ delayed_number          <dbl> 0.25000000, 0.25000000, 0.21428571, 0.15517241…\n```\n\n\n:::\n:::\n\n\n\n\n# International Connections\n\nOur first visualization focuses on international train connections from French stations. We prepare the data by:\n\n1.   Calculating average journey times weighted by the number of trips\n\n2.   Determining whether connections are outgoing or incoming\n\n3.   Computing average delays for both departures and arrivals\n\nThe resulting plot shows the relationship between scheduled journey times and delays for each international connection. The bars represent:\n\n-   Journey time (middle bar)\n\n-   Average departure delay (left bar)\n\n-   Average arrival delay (right bar)\n\nFor each connection, we can see both the outgoing (from France) and incoming (to France) statistics, allowing us to compare service reliability in both directions.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninternational_trains <- small_trains %>% \n  filter(service == \"International\") \n\n\ninternational_connections <- international_trains %>% \n  group_by(departure_station, arrival_station) %>% \n  summarise(average_journey_time = weighted.mean(journey_time_avg, total_num_trips)) %>% \n  mutate(outgoing = arrival_station %in% international_stations,\n         connection = if_else(outgoing, str_c(departure_station, arrival_station, sep = \" - \"), str_c(arrival_station, departure_station, sep = \" - \")))\n\ninternational_delay <- international_trains %>% \n  group_by(arrival_station, departure_station) %>% \n  summarise(average_arriving_delay = weighted.mean(avg_delay_all_arriving, num_late_at_departure), \n            average_departing_delay = weighted.mean(avg_delay_all_departing, num_late_at_departure)) %>% \n  left_join(international_connections, by = c(\"departure_station\", \"arrival_station\")) %>% \n  mutate(average_journey_time2 = average_journey_time) %>% \n  pivot_longer(cols = c(\"average_arriving_delay\", \"average_journey_time\", \"average_departing_delay\")) %>% \n  mutate(name = if_else(\n    outgoing, \n    str_c(\"outgoing_\", name),\n    str_c(\"incoming_\", name)\n  )) %>% \n  mutate(name = factor(name, levels= c(\"outgoing_average_arriving_delay\", \"outgoing_average_journey_time\", \"outgoing_average_departing_delay\", \"incoming_average_departing_delay\", \"incoming_average_journey_time\", \"incoming_average_arriving_delay\")),\n         connection = factor(connection, levels = c(\"PARIS EST - FRANCFORT\", \"PARIS EST - STUTTGART\", \"PARIS LYON - GENEVE\", \"PARIS LYON - LAUSANNE\", \"PARIS LYON - ZURICH\", \"PARIS LYON - ITALIE\", \"PARIS LYON - BARCELONA\", \"MARSEILLE ST CHARLES - MADRID\"))\n         ) \n\ninternational_delay %>% \n  # filter(connection == \"PARIS EST - FRANCFORT\") %>% \n  ggplot(aes(x = outgoing, y = value, fill = name)) + \n    geom_col(width = 0.5) + \n    coord_flip() +\n    facet_wrap(connection ~ ., ncol = 1, strip.position = \"left\") + \n    # TODO arrow for direction\n  \n    labs(x = \"\", y = \"Train delays\") + \n  \n    theme(\n      \n      axis.text.y = element_blank(),\n      legend.position = \"none\"\n    )\n```\n\n::: {.cell-output-display}\n![](2019-02-26---French-Train-Delays_files/figure-html/International Connections Delay-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "2019-02-26---French-Train-Delays_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}